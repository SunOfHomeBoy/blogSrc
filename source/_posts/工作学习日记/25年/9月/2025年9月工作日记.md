<!--
 * @Description:
 * @Date: 2025-09-01 10:48:00
 * @LastEditTime: 2025-09-04 17:18:49
 * @FilePath: \blogSrc\source\_posts\工作学习日记\25年\9月\2025年9月工作日记.md
-->
# 2025年9月1日 周一
+ 石太高速
  + 事件工作台 新增接口
    +

# 2025年9月2日 周二
  + 数字人验证 代理服务
    ```bash
      wget 'https://14.78.1.84:3001/dgapi/index.html' --no-check-certificate
      wget 'https://14.78.1.86/index.html' --no-check-certificate
    ```

# 2025年9月3日 周三
  + 数字人服务
    ```bash
      # 重启数字人服务
      docker restart digitalman_container

      # 清空数字人日志文件(无须重启)
      > sudo truncate -s 0 /var/lib/docker/containers/$CONTAINER_ID/$CONTAINER_ID-json.log
      # 1. cd /var/lib/docker/containers 目录
      # 2. docker ps 获取容器ID
      # 3. 删除日志文件
      sudo truncate -s 0 `{$CONTAINER_ID}-json.log`

      # 使用 管道符 写入log日志(sudo 非必须)
      sudo docker logs digitalman_container >> 20250903_2.log

      ## log日志为空需要排查


      # 数字人交通事件播报 事件超过10个就只播报各类事件总数量，不播报详细内容
    ```

  + clash 代理规则(解决开启VPN后，无法服务数字人IP 的问题)
    ```
      - 'IP-CIDR,14.78.1.0/24,DIRECT' # 如果两个 IP 在同一网段
    ```

  + 本地调试数字人docker服务[搭建本地开发环境]
    ```bash
      # 跳转到 数字人 本地镜像下载目录
      cd /mnt/c/Users/ZSGX/Downloads/14.78.1.86(数字人Docker镜像)/202509020640

      # 查看当前系统 docker 镜像
      (base) lishichen@DESKTOP-0M2EPFH:/mnt/c/Users/ZSGX/Downloads/14.78.1.86(数字人Docker镜像)/202509020640$ docker images
      REPOSITORY                   TAG       IMAGE ID       CREATED        SIZE
      ollama_qwen3_32b_container   latest    ff500d0aa39c   2 months ago   45.1GB
      ollama/ollama                latest    2ea3b768a8f2   3 months ago   5.22GB
      harpooncorp/harpoon-ext      0.0.6     24dab1cbee4a   2 years ago    19.1MB

      # 本地开发电脑 加载 数字人最新docker镜像
      docker load -i digitalman_9_1.tar
      # 本地运行数字人
      docker run -d --name digitalman_container --restart unless-stopped -p 9880:9880 digitalman_9_1

      # 把服务器 ollama地址 SSH 映射到开发机
      ssh -L 0.0.0.0:11434:localhost:11434 os@14.78.1.86 -Nf
      # 数字人 AI Agent(开启VPN 可以直连 14.78.1.86/index.html, 如果无法访问, 考虑 [clash 代理规则 proxy配置])
      # ssh -L 0.0.0.0:8082:localhost:443 os@14.78.1.86 -Nf

      # 本地测试命令 是可以正常流式响应的
      > curl http://localhost:11434/api/generate -d '{"model": "qwen3:14b", "prompt": "你好，自我介绍"}'
      > curl http://172.27.176.1:11434/api/generate -d '{"model": "qwen3:14b", "prompt": "你好，自我介绍"}'

      # 映射成功后 浏览器访问
      [ollama 本地模型api](http://127.0.0.1:11434/api/tags)

      # 把服务器 emoti SSH 映射到开发机
      ssh -L 0.0.0.0:6005:localhost:6005 os@14.78.1.86 -Nf

      # 更新文件
      docker cp ./Agent_1_2.py digitalman_container:/app/src/LLMAgent/Agent_1_2.py
    ```

    + 开发机 数字人docker服务 安装 git[待实现]
      ```bash
        # docker 安装 git
      ```

  + [docker 开启 python 调试模式](<docker debug python.md>)

# 2025年9月4日 周四
  + 解决 LangChain 报错
    * LLM 或 agent function 响应类型为 json, 但是 没有 action 字段 || action 为空
      1. 这种 json 如何处理？
        补全回答: 当LLM返回的JSON缺少action字段或action为空时，通常是因为模型没有按照预期格式输出。处理这种情况的方法包括：
        - 使用输出解析器（Output Parser）来规范化模型输出
        - 在Agent中启用错误处理机制，如handle_parsing_errors=True
        - 为模型提供更明确的提示词，明确要求输出格式
        - 实现重试机制，当解析失败时重新请求模型生成输出
        - 添加默认处理逻辑，当action为空时执行默认操作或返回错误信息
        * 尝试更换大模型 Qwen3:14b, 32b

      2. LangChain 的 action字段 都有哪些类型？
        回答: [ActionType](https://github.com/langchain-ai/langchain/blob/master/libs/langchain-core/)
        回答: 在LangChain的ReAct Agent中，action字段通常是工具的名称。常见的action类型包括：
        - 工具名称：如"search"、"calculator"、"wikipedia"等，对应已注册的工具
        - "Final Answer"：表示任务完成，直接返回结果
        - 自定义工具名称：根据具体应用定义的工具名称
        具体的action类型取决于你为Agent注册了哪些工具。每个工具在创建时都会指定一个名称，这个名称就是action字段的值。

  + 解决 SSH 代理失效问题
    ```bash
      # ollama 代理
      ssh -L 0.0.0.0:11434:localhost:11434 os@14.78.1.86 -Nf
      # emoti
      ssh -L 0.0.0.0:6005:localhost:6005 os@14.78.1.86 -Nf

      # 过一段时间后 curl http://localhost:11434/api/tags 请求会挂起
      # 再次代理 显示端口被占用
      # 过一段时间后 端口才会被释放
      # 这个问题 第一次出现，且复现频率不高，后面再观察
    ```

  + win11 窗口失焦
    现象描述，使用输入法打字, 如果按Esc键，输入框消失，但是编辑器窗口也会失焦。这是什么原因导致的？
    解决:
      结束了 wps 和 360ai 进程，后来失焦现象消失了

  + Ubuntu 暴露代理端口
    + xrk: 429 509 760 / 1234567s

    + 目标服务Host:
      - 45.84.180.197
      - 45.84.180.199

    + [Ubuntu服务器](45.84.180.192) 通过 Nginx代理 目标服务端口
      45.84.180.192:8197
      45.84.180.192:8199

    + 步骤分析
      1. 在Ubuntu服务器上使用 Nginx代理 目标服务端口
        Ubuntu 本地访问 8197 端口，访问目标服务端口 45.84.180.197:80
        Ubuntu 本地访问 8199 端口，访问目标服务端口 45.84.180.199:80

      2. 找到 Nginx conf 配置文件，并编辑
        [服务器conf配置副本](服务器反向代理指定端口_nginx.conf)

      3. 重启 Nginx 服务命令
        nginx -s reload

      4. 测试 Nginx 代理
        curl -v http://localhost:8197

        + 测试结果
          ```bash
            root@t-desktop:/etc/nginx# curl -v http://localhost:8197
             *   Trying 127.0.0.1:8197...
             * TCP_NODELAY set
             * connect to 127.0.0.1 port 8197 failed: Connection refused
             * Failed to connect to localhost port 8197: Connection refused
             * Closing connection 0
             curl: (7) Failed to connect to localhost port 8197: Connection refused
          ```
      5. 如何查看 Nginx 是否已监听 对应端口？

      解决问题
      1. sudo nginx -t
        ```bash
          root@t-desktop:/etc/nginx# sudo nginx -t
          nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
          nginx: configuration file /etc/nginx/nginx.conf test is successful
        ```

      2. 查看 Nginx 是否运行
        ```bash
          sudo systemctl status nginx

          root@t-desktop:/etc/nginx# sudo systemctl status nginx
            ● nginx.service - A high performance web server and a reverse proxy server
                 Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
                 Active: failed (Result: signal) since Sat 2025-07-05 00:00:01 CST; 2 months 0 days ago
                   Docs: man:nginx(8)
                Process: 912 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)
                Process: 1195 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=0/SUCCESS)
               Main PID: 106257 (code=killed, signal=KILL)

            11月 22 05:10:30 t-desktop systemd[1]: Starting A high performance web server and a reverse proxy server...
            11月 22 05:10:30 t-desktop systemd[1]: Started A high performance web server and a reverse proxy server.
            7月 05 00:00:01 t-desktop systemd[1]: nginx.service: Main process exited, code=killed, status=9/KILL
            7月 05 00:00:01 t-desktop systemd[1]: nginx.service: Failed with result 'signal'.

          # 检查系统日志
          sudo journalctl -u nginx.service
          sudo dmesg | grep -i kill

          # 检查内存使用情况
          free -h
          cat /proc/meminfo

          # 测试配置文件
          sudo nginx -t

          # 尝试启动 Nginx
          sudo systemctl start nginx

          # 使用 sudo systemctl start nginx 命令，成功启动 Nginx 服务，并且可以正常返回代理
        ```

    + 在 windows 上使用ssh映射端口
      ```bash
        ssh -L 0.0.0.0:8197:localhost:8197 t@45.84.180.192 -Nf
        ssh -L 0.0.0.0:8199:localhost:8199 t@45.84.180.192 -Nf

        ssh -L 0.0.0.0:81:localhost:80 t@45.84.180.192 -Nf

        # windows 可以 localhost:8197 | 8199 访问
        # Nginx 有时需要 覆盖 80端口 默认服务器
        # default_server; 字段
        # [详见](服务器反向代理指定端口_nginx.conf#L65)
      ```
